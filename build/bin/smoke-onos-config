#!/bin/bash
# Copyright 2020-present Open Networking Foundation.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This script is intended to be run from the onos-test directory as part of CI

set -eu -o pipefail

GREEN="\e[32m"
RED="\e[31m"
RESET="\e[0m"
NAMESPACE=${NAMESPACE:-"micro-onos"}

make_path () {
  target=$1
  path=$2
  IFS=/ read -a elems <<< $path
  result="<target: 'devicesim-1', "
  for i in ${elems[@]}
  do
    result="$result elem: <name: '$i'> "
  done
  result="$result >"
  echo $result
}

extract_timezone() {
  grep json_val: $tmpfile | sed 's/\\n//g' | sed 's/\\//g' | sed -e 's/json_val...//' | sed -e 's/"$//' >$tmpfile.json
  timezone=$(jq '.[][][]."timezone-name"' $tmpfile.json)
  echo $timezone
}

set -eu -o pipefail
onos_test=$PWD
tmpfile="/tmp/smoke$$"
trap "$onos_test/build/bin/setup-artifacts && $onos_test/build/bin/archive-artifacts && rm -f $tmpfile*" EXIT

# configure proxy variables
use_proxy="1"
proxy="mirror.registry.opennetworking.org"

# set up the test KinD cluster
. $onos_test/build/bin/setup-test-cluster
setup_test_cluster

# install onos-config
helm install -n $NAMESPACE $registry \
     --set global.image.tag=latest \
     --set onos-config.image.tag=latest \
     --set onos-topo.image.tag=latest \
     --set onos-config.plugin.compiler.version=v1.0.1 \
     --set import.onos-gui.enabled=false \
     onos onos/onos-umbrella --wait

# install the device simulator
helm install -n $NAMESPACE device-1 $registry onos/device-simulator --wait

# common gnmi_cli arguments
common_args="-address onos-config:5150  -timeout 5s -en JSON -alsologtostderr \
             -insecure -client_crt /etc/ssl/certs/client1.crt -client_key /etc/ssl/certs/client1.key \
             -ca_crt /etc/ssl/certs/onfca.crt"

# Check that plugin models have been loaded correctly
# By default 3 model-plugins are loaded
plugin_count=$($cli_command onos config get plugins --no-headers | grep Loaded | wc -l)
if [[ "$plugin_count" == 3 ]]; then
  echo -e "${GREEN}+++ Correct number of plugins loaded${RESET}"
else
  echo -e "${RED}*** Error: Wrong number of plugins loaded${RESET}"
  exit 1
fi

# Create topo entries for the simulated device
$cli_command onos topo create kind devicesim devicesim
$cli_command onos topo create entity devicesim-1 -a \
                  onos.topo.Configurable='{"address":"devicesim1-device-simulator:11161","version":"1.0.0","type":"devicesim-1.0.x"}' \
                  -a onos.topo.TLSOptions='{"insecure":true,"plain":true}' -k devicesim

# gnmi paths
tzpath=$(make_path 'devicesim-1' '/system/clock/config/timezone-name')
badpath=$(make_path 'devicesim-1' '/XXXsystemXXX/clock/config/timezone-name')

# attempt to set a bad path - should result in an error
bad_set=$($cli_command gnmi_cli -set $common_args -proto \
               "update: <path: $badpath \
                val: <string_val: 'Bad!Value'>>" 2>&1)
if [[ "$bad_set" == *"code = InvalidArgument"* ]]
then
  echo -e "${GREEN}+++ Correct error returned for set of bad path${RESET}"
else
  echo -e "${RED}*** Error not returned for get of bad path${RESET}"
  exit 1
fi

# set an initial timezone value
initial_set=$($cli_command gnmi_cli -set $common_args -proto \
               "update: <path: $tzpath \
                val: <string_val: 'Europe/Paris'>>" 2>&1)
if [[ "$initial_set" == *"op: UPDATE"* ]]
then
  echo -e "${GREEN}+++ Initial timezone set operation successful${RESET}"
else
  echo -e "${RED}*** Error setting initial timezone value${RESET}"
  exit 1
fi

# read the timezone value back and check it
$cli_command gnmi_cli -get $common_args -proto "path: $tzpath" >$tmpfile

timezone=$(extract_timezone)
if [ "$timezone" == '"Europe/Paris"' ]
then
  echo -e "${GREEN}+++ Get of initial timezone setting is correct${RESET}"
else
  echo -e "${RED}*** Get of initial timezone setting is incorrect${RESET}"
  exit 1
fi

# change the timezone
change_set=$($cli_command gnmi_cli -set $common_args -proto \
               "update: <path: $tzpath \
                val: <string_val: 'Europe/Dublin'>>" 2>&1)
if [[ "$change_set" == *"op: UPDATE"* ]]
then
  echo -e "${GREEN}+++ Change timezone set operation successful${RESET}"
else
  echo -e "${RED}*** Error changing timezone value${RESET}"
  exit 1
fi

# check that the modified timezone is correct
$cli_command gnmi_cli -get $common_args -proto "path: $tzpath" >$tmpfile

timezone=$(extract_timezone)
if [ "$timezone" == '"Europe/Dublin"' ]
then
  echo -e "${GREEN}+++ Get of reset timezone setting is correct${RESET}"
else
  echo -e "${RED}*** Get of reset timezone setting is incorrect${RESET}"
  exit 1
fi

# check capabilities
models_count=$($cli_command gnmi_cli -capabilities $common_args | grep supported_models | wc -l)
if [ "$models_count" == '8' ]
then
  echo -e "${GREEN}+++ Models count from capabilities is correct${RESET}"
else
  echo -e "${RED}*** Models count from capabilities is incorrect${RESET}"
  exit 1
fi

echo -e "${GREEN}=== onos-config smoke test completed successfully!${RESET}"

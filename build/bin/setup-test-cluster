#!/bin/bash
# SPDX-FileCopyrightText: 2020-present Open Networking Foundation <info@opennetworking.org>
#
# SPDX-License-Identifier: Apache-2.0

# This script is intended to be run from the onos-test directory as part of CI

set -eu -o pipefail
NAMESPACE=${NAMESPACE:-"micro-onos"}
START_KIND_CLUSTER=${START_KIND_CLUSTER:-"true"}
onos_operator_version=${onos_operator_version:-} # some charts need to load onos-config Models in the old format (eg: ric and e2node in sd-ran)

setup_test_cluster () {
  # configure proxy variables
  use_proxy=${use_proxy:-"1"}

  if [ $use_proxy == "1" ]; then
    proxy="mirror.registry.opennetworking.org"
  else
    echo Skipping proxy configuration because use_proxy is disabled
    proxy=""
  fi

  if [[ "${proxy}" == "" ]]; then
     registry=""
  else
     registry="--set global.image.registry=$proxy"
  fi

  if [ "${START_KIND_CLUSTER}" == "false" ]; then
    echo -e "Not creating kind cluster as START_KIND_CLUSTER is set to ${START_KIND_CLUSTER}, cleaning namespace ${NAMESPACE}"
    kubectl delete ns $NAMESPACE || true
  else
    # Make a kind cluster
    kind delete cluster && kind create cluster --quiet

    # install the preferred versions of k8s tools
    build/bin/install-k8s-tools

    # remove any previous repo definitions
    helm repo remove cord || true
    helm repo remove atomix || true
    helm repo remove onos || true
    helm repo remove sdran || true
    helm repo remove aether|| true

    # set up helm repos
    helm repo add cord https://charts.opencord.org
    helm repo add atomix https://charts.atomix.io
    helm repo add onos https://charts.onosproject.org
    helm repo add sdran https://sdrancharts.onosproject.org
    helm repo add aether https://charts.aetherproject.org
    helm repo update

    # install Atomix
    helm repo update
    if [[ "${proxy}" == "" ]]; then
     helm upgrade --install \
                  atomix-controller atomix/atomix-controller -n kube-system --wait
     helm upgrade --install \
                  atomix-raft-storage atomix/atomix-raft-storage -n kube-system --wait
     registry=""
    else
       helm upgrade --install --set image.registry=$proxy \
                    --set init.image.registry=$proxy \
                    --set broker.image.registry=$proxy \
                    atomix-controller atomix/atomix-controller -n kube-system --wait
       helm upgrade --install --set image.registry=$proxy \
                    --set driver.image.registry=$proxy \
                    --set node.image.registry=$proxy \
                    atomix-raft-storage atomix/atomix-raft-storage -n kube-system --wait
       registry="--set global.image.registry=$proxy --set global.store.consensus.image.registry=$proxy --set global.storage.consensus.image=$proxy/atomix/raft-storage-node:v0.5.3"
    fi

    # initialize the operator
    if [[ "${proxy}" == "" ]]; then
      if [ -z $onos_operator_version ]; then
        helm upgrade --install -n kube-system onos-operator onos/onos-operator --wait
      else
        helm upgrade --install -n kube-system onos-operator onos/onos-operator --wait --version $onos_operator_version
      fi
    else
      if [ -z $onos_operator_version ]; then
        helm upgrade --install $registry -n kube-system onos-operator onos/onos-operator --wait
      else
        helm upgrade --install $registry -n kube-system onos-operator onos/onos-operator --wait --version $onos_operator_version
      fi
    fi
  fi

  # create a namespace for ONOS
  kubectl create namespace $NAMESPACE
}

export cli_command="kubectl -n micro-onos exec -t deploy/onos-cli -- "
export cli_retry_command="$onos_test/build/bin/run-cli-command-with-retry-use-chart-cli"
